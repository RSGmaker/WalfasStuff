<html>
<head>
<title>Walfas recolor by RSGmaker</title>
<!--<script type="text/javascript" src="https://rawgit.com/RSGmaker/WalfasStuff/master/WalfasRender/zip/zip.js"></script>-->
<!--<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script>--> 
<!--<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/StackBlur.js"></script>-->
<!--<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script>  width="500px" -->
</head>
<body>
<a href="http://www.walfas.org/">Walfas assets are by KirbyM</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://github.com/RSGmaker/WalfasStuff">Walfas recolor by RSGmaker</a><br/>
<script src="https://rawgit.com/RSGmaker/WalfasStuff/master/WalfasRender/jquery-1.5.1.js" type="text/javascript"></script>
<div id="player"></div>
<!--<div id="display" height="500px" style="cursor: crosshair" onmousemove="handleMouseMove(event)">-->
<div id="display" style="cursor: crosshair" onmousemove="handleMouseMove(event)">
<img id="pic" height="75%" style="cursor: crosshair" onmousedown="mDown(event)"/>
<!--<canvas id="canvas" width="380px" height="380px" />-->
<button type="button" onclick="uploadrender()">get imgur url</button>
<div id="output"></div>
</div>
<!--<button type="button">Click Me!</button>-->
<!--?.??:Name:Scale:Hat:Hair:Body:Arm:Shoes:Eyes:Mouth:Item:Accessory:Back:HairColor-->
DNA:<input type="text" id="dna" value="3.39:Meiling:100:1:0:1:1:1:0:0:0:0:0:EB585A" onchange="data[this.id]=this.value;ondatachange(this.id)"/><button onclick="dataclear()">Clear</button><!--<button onclick="data['dna']=document.getElementById('dna').value;ondatachange(document.getElementById('dna').id)">Click me</button>--><br/>
Name:<input type="text" id="name" value="Meiling" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Scale:<input type="number" id="scale" value="100" onchange="data[this.id]=this.value;upd=true;"/>	Hat:<input type="number" id="hat" value="1" onchange="data[this.id]=this.value;ondatachange(this.id)"/>Hair:<input type="number" id="hair" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Body:<input type="number" id="body" value="1" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Arm:<input type="number" id="arm" value="1" onchange="data[this.id]=this.value;ondatachange(this.id)"/><br/>
Shoes:<input type="number" id="shoes" value="1" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Eyes:<input type="number" id="eyes" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Mouth:<input type="number" id="mouth" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/>Item:<input type="number" id="item" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Accessory:<input type="number" id="accessory" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/>	Back:<input type="number" id="back" value="0" onchange="data[this.id]=this.value;ondatachange(this.id)"/><br/>
HairColor:<input type="color" id="haircolor" value="#EB585A" onchange="data[this.id]=this.value;ondatachange(this.id)"/>EyeColor:<input type="color" id="eyecolor" value="#000000" onchange="eyecolor=this.value;ondatachange(this.id)"/><br/>
SourceColor:<input type="color" id="srccolor" value="#FFFFFF"/>->NewColor<input type="color" id="newcolor" value="#000000"/><button type="button" onclick="addColor();ondatachange();">Add color change</button><select id="filter">
  <option value="All">All</option>
  <option value="Hat">Hat</option>
  <option value="Hair">Hair</option>
  <option value="Body">Body</option>
  <option value="Arm">Arm</option>
  <option value="Shoes">Shoes</option>
  <option value="Eyes">Eyes</option>
  <option value="Mouth">Mouth</option>
  <option value="Item">Item</option>
  <option value="Accessories">Accessory</option>
  <option value="Wing">Back</option>
  <option value="Background">Background</option>
  <option value="Object">Object</option>
</select><br/>
<div id="colorlist"/>
<div>
	Object(clear character before using):<input type="number" id="object" value="-1" onchange="object=this.value;forceupdate();"/>
	Background(clear character before using):<input type="number" id="background" value="-1" onchange="background=this.value;forceupdate();"/>
</div>
<script>

		/*
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '0',
          width: '0',
          videoId: '0uPInh7MH74',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var done = false;
      function onPlayerStateChange(event) {
		return;
        if (event.data == YT.PlayerState.PLAYING && !done) {
          setTimeout(stopVideo, 6000);
          done = true;
        }
      }
      function stopVideo() {
        player.stopVideo();
      }*/
    </script>
	<script>
	function dataURItoBlob(dataURI) {
    // convert base64/URLEncoded data component to raw binary data held in a string
    var byteString;
    if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
    else
        byteString = unescape(dataURI.split(',')[1]);

    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

    // write the bytes of the string to a typed array
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    return new Blob([ia], {type:mimeString});
}
	function uploadrender() {
		var dataURL = C.toDataURL('image/png');
		var blob = dataURItoBlob(dataURL);
		upload(blob);
	}
	function upload(file) {
                document.body.className = "uploading";

                /* Lets build a FormData object*/
                var fd = new FormData();
                
                fd.append("image", file);
                var xhr = new XMLHttpRequest();
                var output = document.getElementById("output");

				xhr.open("POST", "https://api.imgur.com/3/image.json");
                xhr.onload = function() {

                    if(this.status==400){
					   alert(JSON.parse(xhr.responseText).error.message)
                    } else {
						var response = JSON.parse(xhr.responseText).data.link;
						output.innerHTML=response;
                    }

                }
				xhr.setRequestHeader('Authorization', 'Client-ID fb44620f9404e8d');

                xhr.send(fd);
            }
	</script>
<script>
var repo = "https://cdn.rawgit.com/RSGmaker/WalfasStuff/master/WalfasRender/Ocreateswf/"
var colors = [];
function handleMouseMove(event) {
        event = event || window.event; // IE-ism
        // event.clientX and event.clientY contain the mouse position
		
    }
	function mDown(event) {
        event = event || window.event; // IE-ism
        // event.clientX and event.clientY contain the mouse position
		//srccolor pixelData[0] ("0000" + value).slice(-4)Math.floor
		//var pixelData = ctx.getImageData(event.offsetX, event.offsetY, 1, 1).data;
		var TX = event.offsetX==undefined?event.layerX:event.offsetX;
		var TY = event.offsetY==undefined?event.layerY:event.offsetY;
		//var TX = parseInt(""+event.offsetX);
		//var TY = parseInt(""+event.offsetY);
		
		TX = TX * (500.0 /document.getElementById('pic').clientWidth);
		TY = TY * (500.0 / document.getElementById('pic').clientHeight);
		var pixelData = ctx.getImageData(TX,TY, 1, 1);
		pixelData = pixelData.data;
		if (pixelData[3]>0)
		{
		var TXT = "#" + gethex(pixelData[0]) + gethex(pixelData[1]) + gethex(pixelData[2]);
		//alert(TXT+" "+event.offsetX +" " + event.offsetY);
		document.getElementById("srccolor").value = TXT;
		}
		//document.getElementById("srccolor").value = "#000000";
    }
	function gethex(value){
		return ("00" + value.toString(16)).slice(-2);
	}
	function getsel() {
    var elt = document.getElementById("filter");

    if (elt.selectedIndex == -1)
        return null;

    //return elt.options[elt.selectedIndex].text;
	return elt.options[elt.selectedIndex].value;
	}
function addColor() {
	var src = document.getElementById("srccolor").value;
	var dst = document.getElementById("newcolor").value;
	addColorchange(src,dst,getsel());
	forceupdate();
}
	function addColorchange(src,dst,nfilter) {
		
		var nc = {};
		var index = colors.length;
		nc.src = src;
		nc.dst = dst;
		nc.filter = nfilter;
		//alert(nc.filter);
		//whether or not this rule has been "deleted" or not
		nc.active = true;
		colors[index] = nc;
		//code from ondatachange
		
		var CL = document.getElementById("colorlist");
		var CD = document.createElement('div');
		CD.id = "colordiv"+index;
		//CL.html = CL.html + "blah";
		var tmp = document.createElement('input')
		tmp.type = 'color';
		tmp.value = src;
		tmp.id = "srcnum"+index;
		tmp.addEventListener("change", Function("colors["+index+"].src = this.value;forceupdate();"), false);
		CD.appendChild(tmp);
		tmp = document.createTextNode("->");
		tmp.id = "midnum"+index;
		CD.appendChild(tmp);
		tmp = document.createElement('input')
		tmp.type = 'color';
		tmp.value = dst;
		tmp.id = "dstnum"+index;
		tmp.addEventListener("change", Function("colors["+index+"].dst = this.value;forceupdate();"), false);
		CD.appendChild(tmp);
		tmp = document.createElement('button')
		tmp.innerHTML = "Remove";
		tmp.id = "remnum"+index;
		tmp.addEventListener("click", Function("removecolorindex("+index+");"), false);
		CD.appendChild(tmp);
		tmp = document.createTextNode(""+nc.filter);
		tmp.id = "filternum"+index;
		CD.appendChild(tmp);
		tmp = document.createElement("br");
		tmp.id = "breaknum"+index;
		CD.appendChild(tmp);
		CL.appendChild(CD);
		//forceupdate();
		//colorlist
	}
	function removecolorindex(index)
	{
		//tmp.addEventListener("change", Function("colors["+index+"].dst = this.value;forceupdate();"), false);
		var CL = document.getElementById("colorlist");
		var tmp = document.getElementById("colordiv"+index);
		CL.removeChild(tmp);
		colors[index].active = false;
		//forceupdate();
		ondatachange();
	}
	function addEventHandler(obj, evt, handler) {
    if(obj.addEventListener) {
        // W3C method
        obj.addEventListener(evt, handler, false);
    } else if(obj.attachEvent) {
        // IE method.
        obj.attachEvent('on'+evt, handler);
    } else {
        // Old school method.
        obj['on'+evt] = handler;
    }
}
	function forceupdate()
	{
		OE = [];
		LoadDNA(data["dna"]);
		upd = true;
	}
	function onsrcchange(index)
	{
		colors[index].src = document.getElementById("srcnum"+index).value;
	}
//onchange="data[this.id]=this.value;ondatachange(this.id)"
//onchange="skincolor=this.value;ondatachange(this.id)"
var background=-1;
var object=-1;
var data = {dna:"3.39:Meiling:100:1:0:1:1:1:0:0:0:0:0:EB585A",name:"Meiling",scale:100,hat:1,hair:0,body:1,arm:1,shoes:1,eyes:0,mouth:0,item:0,accessory:0,back:0,haircolor:"#EB585A",eyecolor:"#000000"};
var odata = null;
var upd = true;
odata = jQuery.extend(true, {}, data);
function dataclear()
{
	{
		//var A = prompt("enter DNA","3.39:Meiling:100:1:0:1:1:1:0:0:0:0:0:EB585A");
		//?.??:Name:Scale:Hat:Hair:Body:Arm:Shoes:Eyes:Mouth:Item:Accessory:Back:HairColor
		//alert("dna change!");
		var D = data.dna.split(":");
		data.name = "Untitled";
		data.scale = 100;
		data.hat = -1;
		data.hair = 240;
		data.body = -1;
		data.arm = -1;
		data.shoes = -1;
		data.eyes = -1;
		data.mouth = -1;
		data.item = -1;
		data.accessory = -1;
		data.back = -1;
		data.haircolor = "#000000";
		var vars = ["name","scale","hat","hair","body","arm","shoes","eyes","mouth","item","accessory","back","haircolor"];
		var i = 0;
		while (i < vars.length)
		{
			document.getElementById(vars[i]).value = data[vars[i]];
			i = i+1;
		}
	}
	{
		var vars = ["name","scale","hat","hair","body","arm","shoes","eyes","mouth","item","accessory","back","haircolor"];
		var i = 0;
		var T = "3.39"
		while (i < vars.length)
		{
			T = (T + ":" + data[vars[i]]).replace("#","");
			i = i+1;
		}
		if (data["dna"] == T)
		{
			//if no parts have changed, we'll assume its a color change and reload the entire model
			OE = [];
		}
		data["dna"] = T;
		document.getElementById("dna").value = T;
	}
	//entities = [];
	try {
		//LoadDNA(data["dna"]);
		forceupdate();
	}
	catch(err) {
		//document.getElementById("demo").innerHTML = err.message;
	}
	odata = jQuery.extend(true, {}, data);
	upd = true;
}
function ondatachange()
{
	if (data["dna"] != odata["dna"])
	{
		//var A = prompt("enter DNA","3.39:Meiling:100:1:0:1:1:1:0:0:0:0:0:EB585A");
		//?.??:Name:Scale:Hat:Hair:Body:Arm:Shoes:Eyes:Mouth:Item:Accessory:Back:HairColor
		//alert("dna change!");
		var D = data.dna.split(":");
		data.name = D[1];
		data.scale = parseFloat(D[2]);
		data.hat = parseInt(D[3]);
		data.hair = parseInt(D[4]);
		data.body = parseInt(D[5]);
		data.arm = parseInt(D[6]);
		data.shoes = parseInt(D[7]);
		data.eyes = parseInt(D[8]);
		data.mouth = parseInt(D[9]);
		data.item = parseInt(D[10]);
		data.accessory = parseInt(D[11]);
		data.back = parseInt(D[12]);
		data.haircolor = "#"+D[13];
		var vars = ["name","scale","hat","hair","body","arm","shoes","eyes","mouth","item","accessory","back","haircolor"];
		var i = 0;
		while (i < vars.length)
		{
			//T = (T + ":" + data[vars[i]]).replace("#","");
			document.getElementById(vars[i]).value = data[vars[i]];
			i = i+1;
		}
		//14
		if (D.length>=15)
		{
			colors = [];
			var CL = document.getElementById("colorlist");
			CL.innerHTML = "";
			var TT = D[14].split("/");
			i = 0;
			while (i< TT.length)
			{
				var TTT = TT[i].split(">");
				addColorchange("#"+TTT[0],"#"+TTT[1],TTT[2]);
				i = i+1;
			}
			
		}
	}
	else
	{
		var vars = ["name","scale","hat","hair","body","arm","shoes","eyes","mouth","item","accessory","back","haircolor"];
		var i = 0;
		var T = "3.39"
		while (i < vars.length)
		{
			T = (T + ":" + data[vars[i]]).replace("#","");
			i = i+1;
		}
		i=0;
		if (colors.length>0)
		{
			//T = T + ":";
		}
		var TT = "";
		while (i<colors.length)
		{
			var nc = colors[i];
			if (nc.active)
			{
				//svg = svg.replace(nc.src,nc.dst);
				if (TT != "")
				{
					TT = TT + "/";
				}
				TT = TT + nc.src.replace("#","") + ">" + nc.dst.replace("#","") + ">" + nc.filter;
			}
			i = i+1;
		}
		if (TT != "")
		{
			T = T + ":" + TT;
		}
		if (data["dna"] == T)
		{
			//if no parts have changed, we'll assume its a color change and reload the entire model
			OE = [];
		}
		data["dna"] = T;
		//alert(location.search);
		//if (location.search.indexOf("http://")>-1)
		{
		var pst = "";
		if (background>-1)
		{
			pst = pst + "&background="+background;
		}
		if (object>-1)
		{
			pst = pst + "&object=" + object;
		}
		//var URL = location.search.slice(0, location.search.indexOf(".html")+".html".length);
		if (location.search.indexOf("?dna=") > -1){
			//var TD = location.search.split('?dna=')[0];
			//location.search = TD + "?dna="+T;
			
			
			window.history.pushState('Walfas recolor', data["name"], '?dna='+T+pst);
		}else
		{
			//location.search = location.search + "?dna=" + T;
			window.history.pushState('Walfas recolor', data["name"], '?dna='+T+pst);
		}
		}
		document.getElementById("dna").value = T;
	}
	//entities = [];
	try {
		//LoadDNA(data["dna"]);
		forceupdate();
	}
	catch(err) {
		//document.getElementById("demo").innerHTML = err.message;
	}
	odata = jQuery.extend(true, {}, data);
	upd = true;
}
var C = document.createElement('canvas');
C.width = 380;
	C.height = 380;
//var C = document.getElementById('canvas');
//document.body.appendChild(C);

var filetext,filedata,filetype;
filetext = "";
filetype = "";
var scriptLoaded;
var entities = [];
var Openfile = function(req,type) {
	/*var div = document.createElement('div');
	div.innerHTML = req.responseText;
	document.body.appendChild(div);*/
	if (typeof req == "string")
	{
		req = Loadfile(req);
	}
	//svg[svg.length] = req.responseText.replace(Ooutline,outline).replace(Oskincolor,skincolor);
	if (req != null)
	{
		//var svg = req.responseText.replace(Ooutline,outline).replace(Oskincolor,skincolor); getsel()
		var svg = req.responseText;
		var i = 0;
		while (i<colors.length)
		{
			var nc = colors[i];
			//if (nc.active && ((nc.filter="All" || type == "All") || (type.toLowerCase().contains( nc.filter.toLowerCase()))))
			/*alert(""+nc.filter+" "+type);
			var T = type.toLowerCase();
			var NT = nc.filter.toLowerCase();
			if (nc.active && (T.indexOf(NT)>-1))*/
			if (nc.active && ((nc.filter == "All" || type == "All") || (type.toLowerCase().indexOf( nc.filter.toLowerCase())>-1)))
			{
				svg = svg.replace(nc.src,nc.dst);
			}
			i = i+1;
		}
		var E = {};
		E.svg = svg;
		E.x = 0;
		E.y = 0;
		entities[entities.length] = E;
		return E;
	}
	return null;
}
function Loadfile(url,type){
	if (type == "" || type == null)
	{
		try {
			var req = new XMLHttpRequest();
			req.open('GET', url, false);
			req.send();
			if (req.status === 200 || req.status === 304)
			{
				return req;
			}
		}
		catch(err) {
			//document.getElementById("demo").innerHTML = err.message;
			return null;
		}
	}
	else
	{
		var req = new XMLHttpRequest();
		req.open('GET', url, true);
		req.responseType = filetype;
		req.send();
		req.onload = function(e) {
			Openfile(req,type);
		}
	}
}
//var A = prompt("enter DNA","3.39:Meiling:100:1:0:1:1:1:0:0:0:0:0:EB585A");
//var skincolor = "fff1dd";
var Oskincolor = "#fff1dd"
var skincolor = Oskincolor;
//var skincolor = "#" + prompt("enter skincolor","fff1dd");
var eyecolor = "#000000"
var Ooutline = "#000000"
var outline = Ooutline;
var OD = [];
var ODB = false;
var OE = [];


//var outline = "#" + prompt("enter outlinecolor","000000");
function LoadDNA(dna)
{
	//alert("dna:"+dna);
	//?.??:Name:Scale:Hat:Hair:Body:Arm:Shoes:Eyes:Mouth:Item:Accessory:Back:HairColor
	//var OE = entities;
	var xo = -100;
	var yo = -220;
	entities = [];
	var TB = null;
	if (background>-1)
	{
		TB = LoadPart("Background",""+background);
		TB.x = -200+xo;
		TB.y = -50+yo;
	}
	var D = dna.split(":");
	if (OE[5] == null && D[4]!="240")
	{
		OE[5] = Openfile(repo+"Basichead/1.svg","blarg");
	}
	if (OE[2] == null)
	{
		OE[2] = Openfile(repo+"Basichead/0.svg","blarg");
	}
	if (D[4]=="240")
	{
		OE[2] = null;
		OE[5] = null;
		entities = [];
		if (TB != null)
		{
			entities[0] = TB;
		}
	}
	
	
	
	var Back = LoadPart2("Wings",dec(D[12]),dec(OD[12]),OE[0]);
	var Shoes = LoadPart2("Shoes",dec(D[7]),dec(OD[7]),OE[1]);
	var basichead = null;
	basichead = OE[2];
	entities[entities.length] = basichead;
	var Hair = LoadPart2("Hair",D[4],OD[4],OE[3]);
	var Hair2 = LoadPart2("Hair2",D[4],OD[4],OE[4]);
	var outlinehead = null;
	outlinehead = OE[5];
	entities[entities.length] = outlinehead;
	var Eyes = LoadPart2("Eyes",D[8],OD[8],OE[6]);
	var Mouth = LoadPart2("Mouth",dec(D[9]),dec(OD[9]),OE[7]);
	var Hat = LoadPart2("Hats",dec(D[3]),dec(OD[3]),OE[8]);
	
	
	var Arms = LoadPart2("Arms",dec(D[6]),dec(OD[6]),OE[9]);
	var Item = LoadPart2("Items",dec(D[10]),dec(OD[10]),OE[10]);
	var Body = LoadPart2("body",dec(D[5]),dec(OD[5]),OE[11]);
	var Accessory = LoadPart2("Accessories",dec(D[11]),dec(OD[11]),OE[12]);
	//var OBJ = LoadPart2("Object",""+,dec(OD[11]),OE[12]);
	if (object>-1)
	{
		var OBJ = LoadPart("Objects",""+object);
		OBJ.x = 100+xo;
		OBJ.y = 220+yo;
	}
	
	OE[0] = Back;
	OE[1] = Shoes;
	OE[2] = basichead;
	OE[3] = Hair;
	OE[4] = Hair2;
	OE[5] = outlinehead;
	OE[6] = Eyes;
	OE[7] = Mouth;
	OE[8] = Hat;
	OE[9] = Arms;
	OE[10] = Item;
	OE[11] = Body;
	OE[12] = Accessory;
	/*var Back = LoadPart("Wings",dec(D[12]));
	var Shoes = LoadPart("Shoes",dec(D[7]));
	var basichead = Openfile("https://rawgit.com/RSGmaker/WalfasStuff/master/WalfasRender/createswf/Basichead/0.svg");
	
	var Hair = LoadPart("Hair",D[4]);
	var Hair2 = LoadPart("Hair2",D[4]);
	var outlinehead = Openfile("https://rawgit.com/RSGmaker/WalfasStuff/master/WalfasRender/createswf/Basichead/1.svg");
	var Eyes = LoadPart("Eyes",D[8]);
	var Mouth = LoadPart("Mouth",dec(D[9]));
	var Hat = LoadPart("Hats",dec(D[3]));
	
	
	var Arms = LoadPart("Arms",dec(D[6]));
	var Item = LoadPart("Items",dec(D[10]));
	var Body = LoadPart("body",dec(D[5]));
	var Accessory = LoadPart("Accessories",dec(D[11]));*/
	//bare arms
	
	
	if (Body != null)
	{
		Body.x = 105+xo;
		Body.y = 305+yo;
	}
	if (basichead != null)
	{
		basichead.x = 37+xo;
		basichead.y = 55+yo;
	}
	if (outlinehead != null)
	{
		outlinehead.x = 100+xo;
		outlinehead.y = 305+yo;
	}
	if (Hat != null)
	{
		Hat.x = 100+xo;
		Hat.y = 310+yo;
	}
	if (Arms != null)
	{
		Arms.x = 105+xo;
		Arms.y = 305+yo;
	}
	if (Shoes != null)
	{
		Shoes.x = 102+xo;
		Shoes.y = 305+yo;
	}
	if (Mouth != null)
	{
		Mouth.x = 105+xo;
		Mouth.y = 305+yo;
	}
	if (Eyes != null)
	{
		Eyes.x = 100+xo;
		Eyes.y = 312+yo;//Ooutline
		Eyes.svg = Eyes.svg.replace(outline,eyecolor);
		
	}
	if (Hair != null)
	{
		Hair.x = 100+xo;
		Hair.y = 310+yo;
		Hair.svg = Hair.svg.replace(Hair.svg.substr(Hair.svg.indexOf("#"),7),"#"+D[13])
	}
	if (Hair2 != null)
	{
		Hair2.x = 100+xo;
		Hair2.y = 310+yo;
		//Hair2.svg = Hair2.svg.replace(Hair2.svg.substr(Hair2.svg.indexOf("#"),7),"#"+D[13])
		//Hair2.svg = Hair2.svg.replace(Hair2.svg.substr(Hair2.svg.indexOf("fill=\"#")+6,7),"#"+D[13])
	}
	if (Accessory != null)
	{
		Accessory.x = 47+xo;
		Accessory.y = 63+yo;
		//Accessory.y = 200;
	}
	if (Item != null)
	{
		//3.39:Aya:100:31:30:31:31:31:0:0:47:36:15:332B1A
		//3.39:Reimu (2 Blue):100:112:112:113:111:2:0:0:0:0:0:283960
		Item.x = 68+xo;
		Item.y = 180+yo;
	}
	if (Back != null)
	{
		Back.x = -45+xo;
		Back.y = -30+yo;
	}
	OD = D;
	ODB = true;
	//OE = entities;
}
function dec(strind)
{
	return parseInt(strind)-1;
}
function LoadPart2(feature,index,oldindex,oldentity)
{
	try 
	{			
	if (index == oldindex && oldentity != null)
	{
		//alert("OI:"+oldindex+" OE:"+oldentity)
		entities[entities.length] = oldentity;
		return oldentity;
	}
	return LoadPart(feature,index);
	
	}
			catch(err) {
			}
			return "";
	
}
function LoadPart(feature,index)
{
	if (index >-1)
	{
		var U = repo+feature+"/"+index+".svg";
		return Openfile(U,feature);
	}
	entities[entities.length] = null;
	return null;
}
//LoadDNA(A);
LoadDNA(data.dna);
 
function slice2(str,start,end){
	var SI = str.indexOf(start);
	if (SI == -1)
	{
		return null;
	}
	SI = SI + start.length;
	return str.slice(SI,str.indexOf(end,SI+1));
}
function Pslice2(str,start,end){
	var SI = str.indexOf(start);
	if (SI == -1)
	{
		return null;
	}
	SI = SI + start.length;
	return parseInt(str.slice(SI,str.indexOf(end,SI+1)));
}
function PFslice2(str,start,end){
	var SI = str.indexOf(start);
	if (SI == -1)
	{
		return null;
	}
	SI = SI + start.length;
	return parseFloat(str.slice(SI,str.indexOf(end,SI+1)));
}
function randomcolor()
{
	return Math.round(Math.random() * 16777215).toString(16);
}
function randomcolor2()
{
	return "#"+Math.round(Math.random() * 16777215).toString(16);
}
//draws a decoded svg
function drawSVG(context,SVG,x,y){
	var i = 0;
	var OBJ = SVG.OBJ;
	var Gradients = SVG.Gradients;
	//ctx.translate(x,y);
	while (i < OBJ.length)
	{
		var obj = OBJ[i];
		context.lineJoin = obj.lineJoin;
		context.lineCap = obj.lineCap;
		context.lineWidth = obj.lineWidth;
		if (obj.transform != null)
		{
			var trans = obj.transform;
			//alert("transforming now:"+trans);
			//context.transform(trans[0],0,0,trans[3],0,0);
			context.transform(trans[0],0,0,trans[3],0,0);
		}
		var path = obj.path;
		
		if (obj.fillStyle != null)
		{
			context.globalAlpha = obj.globalAlpha
			if (obj.fillStyle.indexOf("url(#")==0)
			{
				//3.39:Momizi (2):100:149:151:152:146:32:0:0:108:0:65:FBFBFB
				var grd = slice2(obj.fillStyle,"#",")");
				grd = Gradients[grd];
				var gradient = context.createRadialGradient(grd.fx,grd.fy,0,grd.cx,grd.cy,grd.r);
				var j = 0;
				//just implement the first as global since idk how to actually use it.
				context.globalAlpha = grd.stops[0].opacity;
				while (j < grd.stops.length)
				{
					gradient.addColorStop(grd.stops[j].offset,grd.stops[j].color);
					j = j+1;
				}
				context.fillStyle = gradient;
			}
			else
			{
				context.fillStyle = obj.fillStyle;
			}
			context.fill(path);
		}
		if (obj.strokeStyle != null)
		{
			//alert("stroke");
			context.strokeStyle = obj.strokeStyle
			context.stroke(path);
		}
		if (obj.transform != null)
		{
			var trans = obj.transform;
			context.transform(trans[6],0,0,trans[7],0,0);
		}
		i = i + 1;
	}
	//ctx.translate(-x,-y);
}
//drawsvg remade into an array for faster execution and support for post work such as gradients
var DecodeSVG = function(svg){
	var text = svg.split("\n");
	var i = 0;
	var ret = {};
	var OBJ = [];
	var Gradients = {};
	var grd = null;
	var Transforms = {};
	ret.OBJ = OBJ;
	ret.Gradients = Gradients;
	var trans = null;
	while (i < text.length)
	{
		var S = text[i];
		
		var D = -1;
		if (S.indexOf("matrix(") > -1)
		{
			//<g
			var D = S.slice(S.indexOf("matrix(")+7,S.indexOf(")"));
			D = D.split(",");
			var T = [parseFloat(D[0]),parseFloat(D[1]),parseFloat(D[2]),parseFloat(D[3]),parseFloat(D[4]),parseFloat(D[5])];
			D = slice2(S,"xlink:href=\"#","\"");
			if (D != null)
			{
				//alert("transformation "+D + " set as " + T);
				T[6] = 1 / T[0];
				T[7] = 1 / T[3];
				Transforms[D] = T;
			}
		}
		if (S.indexOf("<g id=\"") > -1)
		{
			trans = slice2(S,"<g id=\"","\"");
			if (trans != null)
			{
				//alert("loading transformation"+trans);
				//trans = Transforms[trans];
			}
		}
		if ((D = S.indexOf("<path"))> -1){
			var obj = {};
			D = S.slice(D+9,S.indexOf("\" "));
			var lj = S.indexOf("linejoin=\"");
			if (lj > -1)
			{
				lj = S.substr(lj+10,5);
				obj.lineJoin = lj;
			}
			else
			{
				obj.lineJoin = "miter";
			}
			lj = S.indexOf("linecap=\"");
			if (lj > -1)
			{
				lj = S.substr(lj+9,5);
				obj.lineCap = lj;
			}
			else
			{
				obj.lineCap = "miter";
			}
			lj = S.indexOf("stroke-width=\"");
			if (lj > -1)
			{
				lj = S.slice(lj+14,S.indexOf("\"",lj+15));
				obj.lineWidth = parseInt(lj);
			}
			else
			{
				obj.lineWidth = 1;
			}
			
			obj.path = new Path2D(D);
			var fcolor = slice2(S,"fill=\"","\"");
			
			var scolor = slice2(S,"stroke=\"","\"");
			if (fcolor != null)
			{
				var OP;
				obj.fillStyle=fcolor;
				obj.globalAlpha = PFslice2(S,"fill-opacity=\"","\"");
				if (obj.globalAlpha == null)
				{
					obj.globalAlpha = 1;
				}
			}
			if (scolor.charAt(0) == "#")
			{
				obj.strokeStyle=scolor;
			}
			obj.transform = trans;
			OBJ[OBJ.length] = obj;
		}
		if ((D = S.indexOf("<radialGradient"))> -1){
		grd = {};
		grd.id = slice2(S,"id=\"","\"");
		grd.r = Pslice2(S,"r=\"","\"");
		grd.cx = PFslice2(S,"cx=\"","\"");
		grd.cy = PFslice2(S,"cx=\"","\"");
		grd.fx = PFslice2(S,"fx=\"","\"");
		grd.fy = PFslice2(S,"fx=\"","\"");
		if (grd.fx == null)
		{
			grd.fx = grd.cx;
		}
		if (grd.fy == null)
		{
			grd.fy = grd.cy;
		}
		grd.stops = [];
		Gradients[grd.id] = grd;
	}
	if ((D = S.indexOf("<stop offset=\""))> -1){
		grd.stops[grd.stops.length] = {offset:PFslice2(S,"offset=\"","\""),color:slice2(S,"stop-color=\"","\""),opacity:PFslice2(S,"stop-opacity=\"","\"")};//stop-color="
	}
		i = i+1;
	}
	
	return ret;
}
var randomcols = false;
var drawsvg = function(context,svg,x,y){
	var text = svg.split("\n");
	var i = 0;
	var trans = false;
	var data = {};
	//3.39:Momizi (2):100:149:151:152:146:32:0:0:108:0:65:FBFBFB
	var def = false;
	var Transforms = {};
	var trans = null;
	var Gradients = {};
	var G;
	grd = null;
	//context.save();
	//trans = true;
	//<defs>
	//alert("drawing svg, "+text.length+" lines.");
	while (i < text.length)
	{
		var S = text[i];
		if (S.indexOf("<")>0 && S.indexOf(">")<0)
		{
			i = i+1;
			var ST = text[i];
			S = S + " " + ST;
			while (ST.indexOf(">")<0)
			{
				i = i+1;
				ST = text[i];
				S = S + " " + ST;
			}
			//alert(S);
			//combine multiline into a single line command
		}
		var D = -1;
		if ((D = S.indexOf("<radialGradient"))> -1){
		grd = {};
		grd.id = slice2(S,"id=\"","\"");
		grd.r = Pslice2(S,"r=\"","\"");
		grd.cx = PFslice2(S,"cx=\"","\"");
		grd.cy = PFslice2(S,"cx=\"","\"");
		grd.fx = PFslice2(S,"fx=\"","\"");
		grd.fy = PFslice2(S,"fx=\"","\"");
		if (grd.fx == null)
		{
			grd.fx = grd.cx;
		}
		if (grd.fy == null)
		{
			grd.fy = grd.cy;
		}
		grd.stops = [];
		var gradient = context.createRadialGradient(grd.fx,grd.fy,0,grd.cx,grd.cy,grd.r);
			var j = 0;
			//just implement the first as global since idk how to actually use it.
			//context.globalAlpha = grd.stops[0].opacity;
			/*while (j < grd.stops.length)
			{
				gradient.addColorStop(grd.stops[j].offset,grd.stops[j].color);
				j = j+1;
			}*/
			//grd.grad = gradient
			G = gradient;
			Gradients[grd.id] = gradient;
		}
		if ((D = S.indexOf("<linearGradient"))> -1){
		grd = {};
		grd.id = slice2(S,"id=\"","\"");
		grd.x1 = PFslice2(S,"x1=\"","\"");
		grd.y1 = PFslice2(S,"y1=\"","\"");
		grd.x2 = PFslice2(S,"x2=\"","\"");
		grd.y2 = PFslice2(S,"y2=\"","\"");
		if (grd.x1 == null)
		{
			grd.x1 = 0;
		}
		if (grd.x2 == null)
		{
			grd.x2 = 0;
		}
		if (grd.y1 == null)
		{
			grd.y1 = 0;
		}
		if (grd.y2 == null)
		{
			grd.y2 = 0;
		}
		grd.stops = [];
		var gradient = context.createLinearGradient(grd.x1,grd.y1,grd.x2,grd.y2);
			var j = 0;
			//just implement the first as global since idk how to actually use it.
			//context.globalAlpha = grd.stops[0].opacity;
			/*while (j < grd.stops.length)
			{
				gradient.addColorStop(grd.stops[j].offset,grd.stops[j].color);
				j = j+1;
			}*/
			//grd.grad = gradient
			G = gradient;
			Gradients[grd.id] = gradient;
		}
		//<stop <stop offset=\"
		if ((D = S.indexOf("<stop"))> -1 && grd != null){
		//grd.stops[grd.stops.length] = {offset:PFslice2(S,"offset=\"","\""),color:slice2(S,"stop-color=\"","\""),opacity:PFslice2(S,"stop-opacity=\"","\"")};//stop-color="
		var stop = {offset:PFslice2(S,"offset=\"","\""),color:slice2(S,"stop-color=\"","\""),opacity:PFslice2(S,"stop-opacity=\"","\"")};//stop-color="
		G.addColorStop(stop.offset,stop.color);
	}
	i = i+1;
	}
	i = 0;
	while (i < text.length)
	{
		var S = text[i];
		if (S.indexOf("<")>0 && S.indexOf(">")<0)
		{
			i = i+1;
			var ST = text[i];
			S = S + " " + ST;
			while (ST.indexOf(">")<0)
			{
				i = i+1;
				ST = text[i];
				S = S + " " + ST;
			}
			//alert(S);
			//combine multiline into a single line command
		}
		var D = -1;
		/*if (S.indexOf("<defs>") > -1)
		{
			def = true;
		}
		if (S.indexOf("matrix(") > -1)
		{
			//<g
			var D = S.slice(S.indexOf("matrix(")+7,S.indexOf(")"));
			D = D.split(",");
			if (!def)
			{
			if (S.indexOf("<g "))
			{
				data.maintransform = [parseInt(D[0]),parseInt(D[1]),parseInt(D[2]),parseInt(D[3]),parseInt(D[4]),parseInt(D[5])];
			}
			else if (S.indexOf("<use "))
			{
				var J = S.indexOf("href=\"#")+7;
				J = S.slice(J,S.indexOf(J+1));
				data["Trn"+J] = [parseInt(D[0]),parseInt(D[1]),parseInt(D[2]),parseInt(D[3]),parseInt(D[4]),parseInt(D[5])];
				//data[]
			}
			}
		}
		else if (S.indexOf("<path") > -1)*/
		if (S.indexOf("matrix(") > -1)
		{
			//<g
			D = S.slice(S.indexOf("matrix(")+7,S.indexOf(")"));
			D = D.split(",");
			var T = [parseFloat(D[0]),parseFloat(D[1]),parseFloat(D[2]),parseFloat(D[3]),parseFloat(D[4]),parseFloat(D[5])];
			D = slice2(S,"xlink:href=\"#","\"");
			if (D != null)
			{
				//alert("transformation "+D + " set as " + T);
				T[6] = 1 / T[0];
				T[7] = 1 / T[3];
				Transforms[D] = T;
			}
		}
		if (S.indexOf("<g id=\"") > -1)
		{
			trans = slice2(S,"<g id=\"","\"");
			if (trans != null)
			{
				//alert("loading transformation"+trans);
				trans = Transforms[trans];
			}
		}
		if ((D = S.indexOf("<path"))> -1){
			//var D = S.slice(S.indexOf("<path d=\"")+9,S.indexOf("\" "));
			//D = S.slice(D+9,S.indexOf("\" "));
			D = slice2(S," d=\"","\"");
			//alert("path:"+D);
			var lj = S.indexOf("linejoin=\"");
			if (lj > -1)
			{
				lj = S.substr(lj+10,5);
				context.lineJoin = lj;
			}
			else
			{
				context.lineJoin = "miter";
			}
			lj = S.indexOf("linecap=\"");
			if (lj > -1)
			{
				lj = S.substr(lj+9,5);
				context.lineCap = lj;
			}
			else
			{
				context.lineCap = "miter";
			}
			lj = S.indexOf("stroke-width=\"");
			if (lj > -1)
			{
				lj = S.slice(lj+14,S.indexOf("\"",lj+15));
				context.lineWidth = parseInt(lj);
			}
			else
			{
				context.lineWidth = 1;
			}
			
			var path = new Path2D(D);
			//var fcolor = S.substr(S.indexOf("fill=\"")+6,7);
			
			//var scolor = S.substr(S.indexOf("stroke=\"")+8,7);
			var fcolor = slice2(S,"fill=\"","\"");
			var scolor = slice2(S,"stroke=\"","\"");
			lj = S.indexOf("style=\"");
			if (lj > -1)
			{
				//alert("styl'in");
				var Sty = slice2(S,"style=\"","\"");
				var STYLE = Sty.split(";");
				var II = 0;
				while (II<STYLE.length)
				{
					var SS = STYLE[II].split(":");
					if (SS[0]=="id")
					{
					}
					if (SS[0]=="fill")
					{
						fcolor = SS[1];
					}
					else if (SS[0]=="stroke")
					{
						scolor = SS[1];
					}
					else if (isNaN(SS[1]))
					{
						context[SS[0]] = SS[1];
						//alert(SS[0] + "=(string)" +SS[1]);
					}
					else
					{
						context[SS[0]] = parseFloat(SS[1]);
						//alert(SS[0] + "=(number)" +parseFloat(SS[1]));
					}
					II = II + 1;
				}
				/*if (Sty.indexOf("fill:")>-1)
				{
					fcolor = context.fill;
				}
				if (Sty.indexOf("stroke:")>-1)
				{
					scolor = context.stroke;
				}*/
			}

			ctx.translate(x,y);
			if (trans != null)
			{
				//context.transform(trans[0],0,0,trans[3],0,0);
			}
			if (fcolor != null && (fcolor.charAt(0) == "#" || fcolor.indexOf("url(#")==0))
			{
				
				var OP;
				OP = S.indexOf("fill-opacity=\"");
				if (OP > -1)
				{
					OP = OP+14;
					OP = parseFloat(S.slice(OP,S.indexOf("\"",OP+1)));
					context.globalAlpha = OP;
				}
				if (fcolor.indexOf("url(#")==0)
				{
					fcolor = Gradients[slice2(fcolor,"url(#",")")];
				}
				context.fillStyle=fcolor;
				if (randomcols)
				{
					context.fillStyle=randomcolor2();
				}
				context.fill(path);
				if (OP != -1)
				{
					context.globalAlpha=1;
				}
			}
			if (scolor != null && (scolor.charAt(0) == "#"))
			{
				context.strokeStyle=scolor;
				if (randomcols)
				{
					context.strokeStyle=randomcolor2();
				}
				//var sw = (data[scale] * 0.01) * context.lineWidth;
				//if (sw < 1.1)
				{
					context.stroke(path);
				}
			}
			else
			{
				ctx.strokeStyle = ctx.fillStyle;
				//scolor = fcolor;
				context.lineWidth = 1;
				
				context.stroke(path);
			}
			if (trans != null)
			{
				//context.transform(trans[6],0,0,trans[7],0,0);
			}
			ctx.translate(-x,-y);
		}
		i = i + 1;
	}
}
var tx = 0;
var Angle = 0;
var Test = null;
var update = function(){
	var i = 0;
	// save the current co-ordinate system 
	// before we screw with it
	if (upd)
	{
	ctx.clearRect(0, 0, C.width, C.height);
	var scl = data["scale"] * 0.01;
	//alert("scale:"+scl);
	C.width = 500*scl;
	C.height = 500*scl;
	ctx.save();
	
 
	// move to the middle of where we want to draw our image
	ctx.translate(250*scl, 300*scl);
 
	// rotate around that point, converting our 
	// angle from degrees to radians 
	//ctx.rotate(Angle);
	ctx.scale(0.854*scl,0.854*scl);
	//ctx.scale(-0.5,0.5);
	//Angle = Angle +0.01;
	
	while (i < entities.length)
	{
		var E = entities[i];
		if (E != null && typeof E.svg != 'undefined' && E.svg != null)
		{
			//ctx.translate(E.x,E.y)
			ctx.translate(E.x,E.y);
			//try {
				
				//LoadDNA(data["dna"]);
				//drawsvg(ctx,E.svg,E.x,E.y);
				drawsvg(ctx,E.svg,0,0);
			/*}
			catch(err) {
				//document.getElementById("demo").innerHTML = err.message;
				alert("error:"+err.message);
			}*/
			ctx.translate(-E.x,-E.y);
			/*var SVG = DecodeSVG(E.svg);
			Test = SVG;
			drawSVG(ctx,SVG,E.x,E.y);*/
			//ctx.drawSvg(E.svg, E.x,E.y);
			//ctx.translate(-E.x,-E.y);
		
		}
		i = i + 1;
	}
	// and restore the co-ords to how they were when we began
	ctx.restore(); 
	var disp = document.getElementById('display');
	var pc = document.getElementById('pic');
	
	//try
	{
		
		var IU = C.toDataURL();
		pc.src = IU;
		//var I = new Image();
		//I.src = IU;
		//I.id = "pic";
		//disp.appendChild(I);
		//disp.removeChild(pc);
	}
	/*catch(err) {
			//document.getElementById("demo").innerHTML = err.message;
			return null;
		}*/
	upd = false;
	}
}

var ctx;
ctx = C.getContext("2d")

/*ctx.imageSmoothingEnabled = true;
ctx.webkitImageSmoothingEnabled = true;
ctx.webkitImageSmoothingEnabled = true;
ctx.mozImageSmoothingEnabled = true;*/

ctx.imageSmoothingEnabled = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.mozImageSmoothingEnabled = false;
var Sheight=600;
//C.height = 800;
//C.width = 1200;
//C.width = 380;
//C.height = 380;
function replaceAll(find, replace, str) {
  return str.replace(new RegExp(find, 'g'), replace);
}
var mloop = function(){
		//C = document.getElementById("canvas");
		//alert("what?");
		if (typeof C != "undefined")
		{
		var R = window.innerWidth / window.innerHeight;
		//ctx.fillStyle="#000033";
		//ctx.fillStyle="#ffffff";
		//ctx.fillRect(0, 0, C.width, C.height);
		////ctx.clearRect(0, 0, C.width, C.height);
		/*ctx.fillStyle="white";
		ctx.strokeStyle="white";
		ctx.font="30px Arial";
		C.font="20px Arial";*/

		//G.strokeText("(tap here if using mobile device)",cv.width/3,cv.height/3+30);
		var T = time - ltime;
		T = T / 1000.0;
		if (T>1){
			//force lagg to not cause crazyiness
			T=1;
		}
		//TT += T;
		//LT += T;
		FPS *= 0.95;
		FPS += (T * 0.05);
		}
		update();
		ltime = Date.now();
	requestAnimationFrame(mloop);
}
if (location.search.indexOf("?") > -1){
		var TD = location.search.split('?')[1].split("&");
		var ji = 0;
		while (ji<TD.length)
		{
			var TTD = TD[ji].split("=");
			document.getElementById(TTD[0]).value = TTD[1];
			if (TTD[0]=="dna")
			{
				//data["dna"] = decodeURI(TTD[1]);
				//?dna=3.39:Mayling:100:1:0:1:1:1:0:0:120:0:0:EB585A:90a446>0000ff>Hat/65731e>0000a0>Hat/90a446>ff00ff>Body/65731e>ff80c0>Body/65731e>ff80c0>Arm/006f15>ff0000>Shoes/fcde8b>00ff00>Hat/fff1dd>faca83>All/ffffff>ff0000>Object/484848>ffff00>Item
				//alert(TTD[1]);
				//alert("R:"+replaceAll("%3E",">",TTD[1]));
				data["dna"] = replaceAll("%3E",">",TTD[1]);
				//data["dna"] = TTD[1];
			}
			if (TTD[0]=="background")
			{
				background=parseInt(TTD[1]);
			}
			if (TTD[0]=="object")
			{
				object=parseInt(TTD[1]);
			}
			ji = ji + 1;
		}
		//forceupdate();
		ondatachange();
	}
var FPS = 1;
var ltime = Date.now();
var time = ltime;
requestAnimationFrame(mloop);
</script>
</body>
</html>